---
import MainLayout from '../../layouts/MainLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts', ({ data }) => {
    return data.published === true;
  });

  const tagsSet = new Set<string>();
  allPosts.forEach((post) => {
    post.data.tags.forEach((tag) => {
      if (tag !== 'posts') {
        tagsSet.add(tag);
      }
    });
  });

  return Array.from(tagsSet).map((tag) => ({
    params: { tag },
  }));
}

interface Props {
  tag: string;
}

const { tag } = Astro.params;

const allPosts = await getCollection('posts', ({ data }) => {
  return data.published === true && data.tags.includes(tag);
});

const posts = allPosts.sort((a, b) => 
  b.data.date.getTime() - a.data.date.getTime()
);
---

<MainLayout title={`Tag: ${tag}`} description={`Posts tagged with ${tag}`}>
  <h1 class="post-title mb-8">Tag: {tag}</h1>
  <div class="flex-col">
    {posts.map((post) => (
      <PostCard post={post} isFeed={true} />
    ))}
  </div>
</MainLayout>
